name: Check CDN IPs

# 定义触发器：
# 1. 每天运行 4 次 (每 6 小时一次)
# 2. 手动触发
on:
  schedule:
    # 每天 00:00, 06:00, 12:00, 18:00 UTC 运行
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  check-ip:
    runs-on: ubuntu-latest
    
    # ⭐ 关键修复：授予 GITHUB_TOKEN 写入权限
    # 这是自动提交失败最常见的原因。
    permissions:
      contents: write 

    steps:
      - name: Checkout repository
        # 使用 actions/checkout@v4 来获取代码
        uses: actions/checkout@v4
        # fetch-depth: 0 确保获取完整历史，以便后续提交
        with:
          fetch-depth: 0 

      - name: Run check script
        run: |
          # 确保 check.sh 脚本有执行权限
          chmod +x check.sh
          # 执行脚本，假设它会修改或创建 valid_ips.txt
          ./check.sh

      - name: Commit and push results
        run: |
          # 1. 配置 Git 身份
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          # 2. 暂存更改的文件
          git add valid_ips.txt
          
          # 3. 检查是否有实际更改
          # git diff --cached --exit-code 在没有文件更改时返回非零状态码
          if git diff --cached --exit-code; then
              echo "No changes found in valid_ips.txt. Skipping commit."
          else
              # 4. 提交更改
              git commit -m "Automated update: Check CDN IPs"
              echo "Changes committed. Pushing to remote."
              
              # 5. 推送更改
              # 使用 token 认证推送，将更改推送到当前分支 (通常是 main/master)
              # HEAD 推送至当前分支 (通常是 main/master)。
              git push 
          fi
